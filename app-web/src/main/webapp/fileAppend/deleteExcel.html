<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="GB2312">
        <title>Title</title>
        <script src="./jquery-2.1.3.min.js"></script>
    </head>

    <body>
        源文件: <input type="file" name="file" onchange="addSourceData(this,'#dataSource')" />
		套系选择：<select id="pageType">
                    <option value="cxdb">查询导表</option>
                    <option value="tsdb">投诉导表</option>
                </select> <br> <hr>
        第X列: <input id="orderColume" type="text" value=""  style="width:200px"/> 包含：<input id="haveStr" type="text" value=""  style="width:200px"/>的留下，下面的列 <br>
		<input id="haveColume" type="text" value=""  style="width:800px"/>(多列用英文逗号分隔) <br>

        <button id ="execute" onclick="appendExecute();" >执行</button>

        <textarea  id="dataSource"   style="height: 200px;width:10000px;"></textarea>
        <textarea id="resultData"  style="height: 200px;width:10000px;"></textarea>

        <div id="masking" style="width:100%;height: 100%;position:fixed;top:0px;left: 0px;background-color: rgba(0,255,255,0.5);" hidden="hidden">
            <img style="display: block; height: 37px;margin: 25% auto"  src="./jbox-content-loading.gif" >
        </div>

    </body>

    <script type="text/javascript">

        $(function(){
            var pageInfo={
                "cxdb":{
                    "name":"查询导表",
                    "haveStr":"跟单",
                    "orderColume":60,
                    "haveColume":"1,2,8,54,55,60,112,113,141"
                },
                "tsdb":{
                    "name":"投诉导表",
                    "haveStr":"跟单",
                    "orderColume":155,
                    "haveColume":"1,2,8,54,55,155,163,164,173"
                }
            }

            $("#pageType").bind("change",function(){
                var $this = $(this);
                console.log(pageInfo[$this.val()])
                var page = pageInfo[$this.val()];

              $("#orderColume").val(page.orderColume);
              $("#haveStr").val(page.haveStr);
              $("#haveColume").val(page.haveColume);
            })

            $("#pageType").trigger("change")

        })






	    
        //源数据id
        sourceIds = [];
        /**
         * 添加原始数据
         */
	   function addSourceData(source,id) {
            var file = source.files[0];
            if(window.FileReader) {
                var fr = new FileReader();
                fr.onloadend = function(e) {
                  $(id).empty().val(e.target.result)
                };
                fr.readAsText(file,"GB2312")
            }
        }
        
        /**
         * 执行追加方法显示蒙版
         */
        function appendExecute() {
            $("#masking").show();
            setTimeout(executeData,3000);
        }
        /**
         * 执行追加
         */
        function executeData(){
            //最佳数据
            appendData();
            //下载
            downLoadExecute();
            $("#masking").hide();
        }
        /**
         * 追加数据
         */
        function appendData(){

			var haveStr = $("#haveStr").val()
			var orderColume = $("#orderColume").val()
			var haveData =  $("#haveColume").val().split(",");
            var resultData = $("#resultData");
            resultData.empty();
            var dataSource = $("#dataSource").val();
            //把双引号中的英文到后替换正中文逗号
            dataSource = arrayDouhao(dataSource)
            var trArr = getTrs(dataSource)
			var appendData = "";
            for(i=0;i<trArr.length;i++){
                var columeArr = trArr[i].split(",");
				if(columeArr[orderColume-1]&&columeArr[orderColume-1].indexOf(haveStr)>=0){
					for(j=0;j<haveData.length;j++){
					   appendData=appendData+(typeof(columeArr[haveData[j]-1]) == "undefined"?"":columeArr[haveData[j]-1])+",";
					}
					resultData.append("\r\n").append(appendData.replaceAll("\"","").replaceAll("“",""));
					appendData="";
				}
            }
        }





        String.prototype.replaceAll = function(s1,s2){
             return this.replace(new RegExp(s1,"gm"),s2);
        }

        /**
         * 把双引号中的英文逗号变成中文逗号
         */
        function arrayDouhao(str){
            var regex=RegExp("(\".*?),(.*?\")");
            while(regex.test(str)){
                str = str.replaceAll(regex,"$1，$2");
            }
            return str;
        }

        /**
         * 获取行数据
         */
        function getTrs(yuandata){
            var trArr = yuandata.split(/\r?\n/);
            return trArr;
        }

        

        /**
         * 下载
         */
        function downLoadExecute () {
            var filename = "quickDelete.txt";
            var content =$("#resultData").val();
            download(filename, content);
        };
        /**
         * 下载执行
         */
        function download(filename, content) {
            var blob = new Blob([content], {type: 'text/html,charset=GB2312' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');

            a.style = "display: none";
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 5);
        }



    </script>
</html>