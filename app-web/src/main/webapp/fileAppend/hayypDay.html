<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="GB2312">
        <title>Title</title>
        <script src="./jquery-2.1.3.min.js"></script>
    </head>

    <body>
	    
        源文件: <input type="file" name="file" onchange="addSourceData(this,'#dataSource')" /> 
		追加文件:<input type="file" name="file" onchange="addSourceData(this,'#appendSourc')" /> 
        <button id ="execute" onclick="appendExecute();" >执行</button>

        <textarea  id="dataSource"   style="height: 200px;width:10000px;"></textarea>
        <textarea id="appendSourc"  style="height: 200px;width:10000px;"></textarea>
        <textarea id="resultData"  style="height: 200px;width:10000px;"></textarea>

        <div id="masking" style="width:100%;height: 100%;position:fixed;top:0px;left: 0px;background-color: rgba(0,255,255,0.5);" hidden="hidden">
            <img style="display: block; height: 37px;margin: 25% auto"  src="./jbox-content-loading.gif" >
        </div>
    </body>

    <script type="text/javascript">
        //源数据id
        sourceIds = [];
        /**
         * 添加原始数据
         */
	   function addSourceData(source,id) {
            var file = source.files[0];
            if(window.FileReader) {
                var fr = new FileReader();
                fr.onloadend = function(e) {
                  $(id).empty().val(e.target.result)
                };
                fr.readAsText(file,"GB2312")
            }
        }
        
        /**
         * 执行追加方法显示蒙版
         */
        function appendExecute() {
            $("#masking").show();
            setTimeout(executeData,3000);
        }
        /**
         * 执行追加
         */
        function executeData(){
            //设置源id
            setSourceIds();
            //最佳数据
            appendData();
            //下载
            downLoadExecute();
            $("#masking").hide();
        }
        /**
         * 设置源id
         */
        function setSourceIds(){
            var dataSource = $("#dataSource").val();
            var trArr = getTrs(dataSource);
            for(i=0;i<trArr.length;i++){
                var columeArr = trArr[i].split(",");
                var key = columeArr[0];
                sourceIds[key]=1;
            }
        }
        /**
         * 获取行数据
         */
        function getTrs(yuandata){
            var trArr = yuandata.split(/\r?\n/);
            return trArr;
        }

        /**
         * 追加数据
         */
        function appendData(){
            var resultData = $("#resultData");
            resultData.empty();
            var appendSourc = $("#appendSourc").val();
            var trArr = getTrs(appendSourc)
            for(i=0;i<trArr.length;i++){
                var columeArr = trArr[i].split(",");
                var key = columeArr[0];
                if(sourceIds[key]!=1){
                    sourceIds[key]=1;
                    resultData.append("\r\n").append(trArr[i])
                }
            }
        }

        /**
         * 下载
         */
        function downLoadExecute () {
            var filename = "happyDay.txt";
            var content = $("#dataSource").val()+$("#resultData").val();
            download(filename, content);
        };
        /**
         * 下载执行
         */
        function download(filename, content) {
            var blob = new Blob([content], {type: 'text/html,charset=GB2312' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');

            a.style = "display: none";
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 5);
        }
		



    </script>
</html>